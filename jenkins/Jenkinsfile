pipeline {
    agent {
        dockerfile {
            filename 'jenkins/Dockerfile.jenkins'
            dir 'jenkins'
            label 'built-in'
        }
    }

    environment {
        ENV_VARS_FILE = 'jenkins/jenkins-env-vars.sh'
    }

    options {
        skipDefaultCheckout true
    }

    stages {

        stage('Load Environment Variables') {
            steps {
                script {
                    envVars = readFile("${ENV_VARS_FILE}").split("\n")
                    envVars.each {
                        if (it.trim() && it.contains("=")) {
                            def (key, value) = it.tokenize("=")
                            env[key.trim()] = value.trim().replaceAll("\"", "")
                        }
                    }
                }
            }
        }

        stage('Checkout') {
            steps {
                git credentialsId: 'github-creds', url: "${env.GITHUB_REPO_URL}", branch: "${env.GIT_BRANCH}"
            }
        }

        stage('Start SonarQube Locally (if needed)') {
            steps {
                script {
                    def sonarRunning = sh(script: "docker ps | grep sonarqube || true", returnStdout: true).trim()
                    if (!sonarRunning) {
                        sh '''
                        docker run -d --name sonarqube \
                            -e SONAR_ES_BOOTSTRAP_CHECKS_DISABLE=true \
                            -p 9000:9000 sonarqube:lts
                        sleep 30
                        '''
                    }
                }
            }
        }

        stage('SonarQube Scan') {
            steps {
                withCredentials([string(credentialsId: 'sonarqube-creds', variable: 'SONAR_AUTH_TOKEN')]) {
                    withSonarQubeEnv('SonarQube Server') {
                        sh """
                            sonar-scanner \
                            -Dsonar.projectKey=${SONAR_PROJECT_KEY} \
                            -Dsonar.sources=src \
                            -Dsonar.host.url=${SONAR_HOST_URL} \
                            -Dsonar.login=${SONAR_AUTH_TOKEN}
                        """
                    }
                }
            }
        }

        stage('Terraform Init & Apply') {
            steps {
                withCredentials([usernamePassword(credentialsId: 'aws-creds',
                    usernameVariable: 'AWS_ACCESS_KEY_ID',
                    passwordVariable: 'AWS_SECRET_ACCESS_KEY')]) {
                    dir("${env.TERRAFORM_DIR}") {
                        sh '''
                        terraform init
                        terraform apply -auto-approve
                        '''
                    }
                }
            }
        }

        stage('Trivy Vulnerability Scan') {
            steps {
                sh '''
                trivy fs . > trivy-report.txt
                echo "==== Trivy Scan Complete ===="
                '''
            }
        }

        stage('Build and Push Docker Image to ECR') {
            steps {
                withCredentials([usernamePassword(credentialsId: 'aws-creds',
                    usernameVariable: 'AWS_ACCESS_KEY_ID',
                    passwordVariable: 'AWS_SECRET_ACCESS_KEY')]) {
                    sh '''
                    aws configure set aws_access_key_id $AWS_ACCESS_KEY_ID
                    aws configure set aws_secret_access_key $AWS_SECRET_ACCESS_KEY
                    aws configure set default.region ${AWS_REGION}

                    aws ecr get-login-password --region ${AWS_REGION} | docker login --username AWS --password-stdin ${ECR_REPO_URI}

                    docker build -t ${ECR_REPO_NAME}:${DOCKER_IMAGE_TAG} .
                    docker tag ${ECR_REPO_NAME}:${DOCKER_IMAGE_TAG} ${ECR_REPO_URI}:${DOCKER_IMAGE_TAG}
                    docker push ${ECR_REPO_URI}:${DOCKER_IMAGE_TAG}
                    '''
                }
            }
        }

        stage('Trivy Scan - Docker Image') {
            steps {
                sh '''
                echo "Running Trivy scan on built Docker image..."
                trivy image ${ECR_REPO_NAME}:${DOCKER_IMAGE_TAG} > trivy-image-report.txt
                '''
            }
        }


        stage('Deploy to Kubernetes') {
            steps {
                sh '''
                kubectl apply -f ${K8S_DEPLOYMENT_PATH} --namespace=${K8S_NAMESPACE}
                kubectl apply -f ${K8S_SERVICE_PATH} --namespace=${K8S_NAMESPACE}
                '''
            }
        }

    }

    post {
        always {
            echo 'Cleaning up...'
            sh 'docker container prune -f || true'
        }
        failure {
            echo 'Pipeline failed!'
        }
        success {
            echo 'Pipeline completed successfully.'
        }
    }
}
